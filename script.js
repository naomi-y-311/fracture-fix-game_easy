const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const title = document.getElementById('title');
    const body = document.body;

    // --- ゲーム設定 ---
    const baseWidth = 400;
    const baseHeight = 600;
    let scale = 1;
    const snapDistance = 30; // 吸着距離

    // --- ピース定義 ---
    const piecesDef = [
        {
    name: "bone_0",
    type: 'bone',
    // ▼ Figmaのサイドバーの数値をそのまま書く
    targetX: 109, 
    targetY: 78,
    // ▼ Figmaからコピーした d="..." の中身
    pathData: "M24.3092 0.676627C25.3709 0.713609 51.097 -0.209172 51.0564 1.83097C50.7519 16.6205 48.222 31.2315 46.7241 45.9198C41.5036 97.1102 35.7412 148.984 35.9941 200.46C36.0185 205.424 35.6687 210.418 35.213 215.425C31.9988 219.356 28.3411 224.133 24.856 227.574C24.6866 227.741 24.3836 227.798 23.8635 227.662C23.3591 227.529 22.7718 227.244 22.177 226.92C21.6048 226.609 21.0006 226.247 20.5413 226.02C20.3099 225.906 20.0791 225.806 19.8771 225.761C19.7169 225.726 19.4172 225.691 19.2086 225.908L19.1681 225.955C18.6393 226.637 18.2968 227.27 18.03 227.785C17.7509 228.323 17.5831 228.667 17.3868 228.876C17.3003 228.968 17.2227 229.016 17.1434 229.039C17.062 229.063 16.946 229.071 16.7686 229.032C16.3964 228.95 15.8452 228.682 14.9781 228.124C14.3047 227.69 13.0476 226.976 11.5691 226.107C10.082 225.232 8.35349 224.19 6.70982 223.087C5.06352 221.982 3.51566 220.825 2.38335 219.72C1.8172 219.168 1.36461 218.638 1.0558 218.143C0.745237 217.646 0.596863 217.212 0.596863 216.843C0.596829 216.764 0.572506 216.691 0.531036 216.63C13.2572 151.738 5.41174 84.9607 14.4791 19.651C15.2826 13.5671 16.2622 7.8938 15.6831 1.70042C18.4245 1.22044 21.5022 0.578686 24.3092 0.676627Z", 
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_1",
    type: 'bone',
    // ▼ Figmaのサイドバーの数値をそのまま書く
    targetX: 119.58, 
    targetY: 306.06,
    // ▼ Figmaからコピーした d="..." の中身
    pathData: "M4.24547 1.03198C4.89977 1.45308 5.42969 1.74799 5.87162 1.91676C5.70183 2.34414 5.48711 2.85141 5.32405 3.35463C5.14243 3.9152 5.0062 4.52609 5.05818 5.11758L5.0681 5.23195L5.14055 5.32132C5.21634 5.41503 5.34195 5.53708 5.44835 5.64308C5.56555 5.75986 5.68493 5.88159 5.7852 6.00311C5.88923 6.12922 5.95014 6.22862 5.97385 6.2973C5.97705 6.3066 5.97803 6.31435 5.97937 6.31973C5.92331 6.38462 5.81711 6.4825 5.5811 6.68085C5.33744 6.88562 4.96487 7.19132 4.42824 7.6458C3.33392 8.57258 1.66605 10.0788 0.641243 10.872C0.575468 10.9229 0.511708 10.9714 0.451118 11.018C1.03681 9.79263 1.70286 8.19063 2.2924 6.59444C2.74939 5.35709 3.16538 4.11077 3.4677 3.02919C3.70185 2.19144 3.8742 1.42876 3.93804 0.839661C4.05101 0.909027 4.15389 0.973044 4.24547 1.03198Z", 
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_2",
    type: 'bone',
    // ▼ Figmaのサイドバーの数値をそのまま書く
    targetX: 106.68, 
    targetY: 301.92,
    // ▼ Figmaからコピーした d="..." の中身
    pathData: "M10.0324 0.576447C11.3539 1.42718 12.6812 2.22406 13.8528 2.91309C14.7572 3.44497 15.5619 3.91044 16.2027 4.28806C16.2 4.79593 16.0295 5.64858 15.7331 6.70889C15.4378 7.76521 15.0288 8.99115 14.5765 10.2157C13.7666 12.4086 12.831 14.5585 12.1767 15.7152C8.51553 13.4505 4.71336 11.7934 0.539879 10.4569C0.639871 9.50819 0.740009 8.5612 0.842161 7.61758C0.866354 7.60057 0.889501 7.58091 0.909826 7.55765C1.16608 7.26423 1.76513 6.72231 2.57054 6.04807C3.368 5.38049 4.34699 4.5999 5.34478 3.83501C6.34265 3.07006 7.35712 2.32278 8.22566 1.72086C8.99335 1.18884 9.62697 0.784436 10.0324 0.576447Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_3",
    type: 'bone',
    targetX: 107.11, 
    targetY: 295.7,
    pathData: "M2.55816 1.48712C2.61819 1.60241 2.68422 1.71737 2.75564 1.8317C3.10767 2.3952 3.60524 2.97217 4.19571 3.54831C5.37668 4.70059 6.96876 5.88799 8.62846 7.00177C8.74933 7.08288 8.87128 7.16299 8.99289 7.24338C8.5697 7.49099 8.04419 7.83547 7.47007 8.23334C6.58884 8.84405 5.56418 9.59922 4.55977 10.3692C3.55528 11.1392 2.56786 11.9266 1.76053 12.6025C1.3354 12.9584 0.954017 13.2887 0.644806 13.5715C1.02989 10.1272 1.47254 6.73939 2.14739 3.49794C2.28688 2.82794 2.42317 2.15753 2.55816 1.48712Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_4",
    type: 'bone',
    targetX: 119.09, 
    targetY: 294.27,
    pathData: "M25.6842 1.60074C25.379 4.834 25.0407 8.07185 24.738 11.3091C24.7226 11.3162 24.7077 11.3243 24.6935 11.3334C24.6987 11.3301 24.7034 11.3275 24.7034 11.3275L24.7067 11.3257C24.7015 11.3284 24.6914 11.3334 24.6755 11.3415C24.644 11.3573 24.5977 11.3804 24.5379 11.4102C24.4192 11.4694 24.2518 11.5533 24.0603 11.6511C23.679 11.8457 23.1943 12.1005 22.8015 12.3362C20.3663 13.7972 18.2884 15.9961 16.312 17.8884C15.9469 18.2378 15.7171 18.4532 15.5901 18.5757C15.5267 18.6368 15.4745 18.6887 15.4371 18.7312C15.4178 18.7532 15.3503 18.8268 15.3202 18.9353L15.3095 18.9842C15.2782 19.1949 15.3588 19.3723 15.4735 19.4991C15.5784 19.6149 15.7165 19.6958 15.8446 19.755C16.1023 19.8741 16.4447 19.9607 16.7801 20.033C16.9517 20.07 17.1302 20.105 17.3045 20.1389C17.48 20.1731 17.6513 20.2061 17.8145 20.2404C18.1492 20.3108 18.4164 20.3797 18.5879 20.4556C18.8352 20.5649 19.1137 20.5351 19.3366 20.485C19.5719 20.4321 19.8233 20.3376 20.0574 20.2404C20.2702 20.1521 20.5543 20.024 20.7362 19.9473C20.9512 19.8568 21.1159 19.7968 21.2312 19.7741C21.3017 19.7603 21.3975 19.7712 21.5298 19.833C21.663 19.8952 21.808 19.9974 21.9616 20.1279C22.114 20.2575 22.2606 20.4023 22.4021 20.5431C22.5353 20.6756 22.6786 20.8198 22.8022 20.9171L22.8077 20.9215L22.8136 20.9255C22.9601 21.0321 23.1016 21.1477 23.2545 21.2712C23.4044 21.3922 23.5644 21.5201 23.7337 21.6386C23.8086 21.691 23.8959 21.7125 23.9805 21.7055C23.9312 22.8319 23.8964 23.9577 23.8779 25.0825C22.9569 25.7854 21.7917 26.4933 20.5983 27.2099C19.3209 27.9769 18.0104 28.7552 16.9978 29.5281C16.5266 29.8877 16.1202 30.2108 15.7876 30.4783C15.684 30.3341 15.5363 30.1314 15.3235 29.8484C15.0043 29.4241 14.6701 28.9495 14.3162 28.4499C13.9638 27.9523 13.5933 27.4318 13.2075 26.9249C12.4394 25.9158 11.5907 24.9334 10.6657 24.2698C10.5346 24.1758 10.388 24.1627 10.2847 24.1672C10.1773 24.1718 10.068 24.1975 9.96695 24.2297C9.76373 24.2944 9.52658 24.4071 9.27817 24.5423C8.77738 24.8148 8.16472 25.2156 7.55972 25.6308C6.95334 26.0469 6.34069 26.4873 5.84274 26.8399C5.5925 27.0171 5.37186 27.1719 5.19294 27.2922C5.04008 27.395 4.93034 27.4628 4.86308 27.5C4.84065 27.4952 4.80414 27.4857 4.75165 27.464C4.61653 27.408 4.43247 27.3038 4.19195 27.1484C3.70938 26.8368 3.08835 26.3781 2.30654 25.8327C1.83477 25.5035 1.36108 25.1862 0.88559 24.8791C1.13297 24.7003 1.49661 24.4296 2.02338 24.0219C3.06321 23.2171 4.77932 21.6701 5.83649 20.7747C6.37545 20.3183 6.73156 20.0264 6.98714 19.8116C7.22905 19.6083 7.39609 19.4626 7.50382 19.3277C7.69441 19.0889 7.67917 18.8157 7.60716 18.6066C7.53911 18.409 7.40958 18.226 7.28759 18.0781C7.16176 17.9256 7.0193 17.7811 6.90146 17.6637C6.82666 17.5891 6.76758 17.5304 6.72274 17.4842C6.70992 17.0733 6.80728 16.6188 6.96214 16.1409C7.13055 15.6211 7.34705 15.1258 7.53655 14.6401C7.68042 14.6449 7.81908 14.6301 7.95247 14.5908C8.18828 14.5213 8.37595 14.3869 8.53166 14.2212C8.81993 13.9145 9.04672 13.439 9.29472 12.9603C9.54427 12.4785 9.84712 11.9223 10.3001 11.3242C10.3032 11.3248 10.3067 11.3253 10.3101 11.326C10.4188 11.3502 10.5819 11.4149 10.8036 11.5246C11.2509 11.7459 11.7917 12.073 12.4135 12.4112C13.0126 12.7371 13.6688 13.0618 14.2684 13.2195C14.8523 13.373 15.514 13.4007 15.9813 12.9393C19.2457 9.7161 22.6631 5.32997 25.6842 1.60074Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_5",
    type: 'bone',
    targetX: 134.37, 
    targetY: 304.86,
    pathData: "M9.37203 0.85144C9.10664 3.75999 8.87636 6.66778 8.73326 9.5713C8.63817 9.49925 8.54283 9.42278 8.44349 9.34258C8.29835 9.22541 8.14284 9.09908 7.98087 8.98071C7.90056 8.91706 7.79495 8.81245 7.6488 8.66702C7.50929 8.5282 7.34308 8.36323 7.16485 8.21176C6.98775 8.06126 6.78411 7.91078 6.56396 7.80798C6.34305 7.70484 6.08047 7.63831 5.80201 7.69289C5.60253 7.73203 5.37377 7.82071 5.15956 7.91095C4.91241 8.01507 4.73069 8.09998 4.48439 8.20221C4.25931 8.29562 4.05684 8.36961 3.88718 8.40778C3.70532 8.44867 3.62701 8.43267 3.60806 8.42432C3.35601 8.31285 3.01765 8.23086 2.6854 8.16101C2.5153 8.12525 2.3375 8.0907 2.16394 8.05695C1.98906 8.02293 1.81752 7.98953 1.65425 7.95435C1.32001 7.88231 1.05112 7.80958 0.87648 7.72893C1.00929 7.60201 1.21388 7.41072 1.54871 7.09016C3.56841 5.15655 5.56306 3.04445 7.90475 1.6395C8.27453 1.41766 8.74022 1.1724 9.11829 0.979401C9.20909 0.933049 9.2947 0.890353 9.37203 0.85144Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_6",
    type: 'bone',
    targetX: 102.63, 
    targetY: 312.56,
    pathData: "M4.85902 0.664948C8.97747 1.99436 12.7186 3.64011 16.3193 5.88503C16.3476 5.95351 16.3965 6.01432 16.4635 6.0575C16.5326 6.10203 16.6108 6.1204 16.687 6.11633C17.2425 6.4699 17.7948 6.83808 18.3448 7.22177C19.0997 7.7484 19.7561 8.23192 20.2527 8.55261C20.5016 8.71337 20.7325 8.84802 20.933 8.93103C21.0336 8.97268 21.1412 9.0076 21.2496 9.02185C21.3576 9.03603 21.4919 9.03284 21.6229 8.96964C21.7383 8.91388 21.9021 8.80956 22.0825 8.68831C22.2697 8.56252 22.4968 8.40352 22.7474 8.22606C23.2514 7.86912 23.8549 7.43482 24.4552 7.02281C25.057 6.60979 25.6429 6.22793 26.1075 5.97513C26.3415 5.84781 26.5293 5.76191 26.6646 5.71881C26.7029 5.70662 26.7321 5.69961 26.7528 5.69563C27.5621 6.29138 28.3368 7.17932 29.0773 8.15215C29.4545 8.64763 29.8181 9.15877 30.1706 9.65657C30.5217 10.1523 30.8635 10.6373 31.1907 11.0724C31.4204 11.3778 31.571 11.5854 31.6703 11.7244C31.4656 11.8913 31.3414 11.9927 31.2904 12.0278C31.148 12.1258 31.0057 12.2551 30.8774 12.3764C30.7411 12.5054 30.6203 12.6252 30.4924 12.7393C30.3659 12.8522 30.2557 12.9376 30.1596 12.9913C30.095 13.0273 30.0517 13.04 30.0254 13.0442L30.0202 13.0416C29.979 13.0207 29.9201 12.9881 29.843 12.9431C29.6894 12.8534 29.4829 12.7266 29.2347 12.5735C28.7418 12.2694 28.0961 11.8689 27.4306 11.4887L27.2721 11.3982L27.1029 11.4662C25.9372 11.9359 25.0425 12.7215 24.2401 13.5524C23.4201 14.4015 22.7332 15.2519 21.8983 15.9902C21.5397 16.283 21.2316 16.3699 20.9646 16.3609C20.6868 16.3514 20.404 16.2363 20.1081 16.038C19.8116 15.8392 19.5273 15.5746 19.2469 15.2977C18.9786 15.0328 18.6968 14.7384 18.4412 14.5339C18.2176 14.3552 17.9641 14.4196 17.8234 14.4817C17.6779 14.546 17.5353 14.6547 17.41 14.7619C17.1602 14.9758 16.8532 15.299 16.5819 15.5629C16.2894 15.8473 16.0261 16.0758 15.8085 16.1877C15.7023 16.2422 15.6404 16.2508 15.6132 16.2494C15.6029 16.2489 15.5882 16.2493 15.557 16.2127C15.4317 16.0657 15.1046 15.6833 14.7079 15.2812C14.3429 14.9113 13.893 14.4977 13.473 14.2445L13.3895 14.1963L13.3487 14.1761C13.2529 14.1347 13.1581 14.1314 13.099 14.1331C13.0208 14.1353 12.9369 14.1489 12.8519 14.1684C12.6809 14.2077 12.4621 14.2818 12.1932 14.3942C11.6532 14.62 10.8698 15.0175 9.78528 15.6622C8.59809 16.3678 7.45244 17.1316 6.31896 17.8943C5.18301 18.6588 4.06024 19.4216 2.90669 20.1357C1.99181 20.7021 1.34797 21.0515 0.895882 21.2673C3.27385 14.8341 4.11163 7.71776 4.85902 0.664948Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_7",
    type: 'bone',
    targetX: 87.2, 
    targetY: 318.7,
    pathData: "M55.3736 0.973724C55.3373 5.57987 55.5981 10.1699 56.3654 14.7294C55.5119 15.3707 54.3684 15.8367 53.4782 16.421C48.5986 19.6244 43.5363 22.6061 39.0231 26.3258C37.6573 27.4515 37.7941 27.8432 39.2842 28.6234C34.6288 31.8607 29.813 34.8436 25.2221 38.2027C24.5394 38.7023 23.5261 39.2239 23.03 39.9462C22.2881 41.0273 26.9763 41.1512 27.5422 41.2811C28.0728 41.4028 28.5227 41.6857 29.0705 41.758C25.5695 44.239 22.03 46.6444 18.6907 49.3475C14.391 52.8279 10.2765 56.5262 6.08417 60.1329C5.00389 58.1749 3.94838 56.345 3.17902 55.15C0.0229471 50.2481 -0.0576168 44.8418 1.45689 39.7954C2.9694 34.7557 6.07722 30.0509 9.34383 26.4946C12.1267 23.4648 14.108 20.0582 15.5609 16.4155C16.0623 16.2446 16.8897 15.8521 18.3413 14.9534C19.51 14.2299 20.6468 13.4574 21.7779 12.6962C22.9115 11.9333 24.0414 11.1802 25.2085 10.4864C26.2768 9.85146 27.0267 9.47336 27.522 9.26628C27.7706 9.16234 27.9457 9.10551 28.0589 9.07947C28.0846 9.07355 28.1053 9.06977 28.121 9.06732C28.4516 9.26606 28.8481 9.62 29.2103 9.98705C29.587 10.3689 29.8991 10.7344 30.0219 10.8784C30.1789 11.0626 30.3825 11.1664 30.6117 11.1785C30.8242 11.1897 31.0236 11.1203 31.1909 11.0344C31.5208 10.8648 31.8566 10.56 32.1449 10.2798C32.4543 9.97893 32.7108 9.70544 32.9377 9.51118C33.0089 9.45027 33.0651 9.4085 33.1069 9.38138C33.2958 9.5462 33.5042 9.76202 33.7559 10.0106C34.0398 10.2909 34.3667 10.5996 34.7268 10.8409C35.0874 11.0827 35.5072 11.2747 35.9771 11.2907C36.4569 11.307 36.9408 11.1383 37.4183 10.7468L37.4286 10.738C38.2913 9.9763 39.0623 9.03743 39.82 8.25278C40.5544 7.4923 41.3149 6.82996 42.2555 6.41298C42.8507 6.7575 43.4229 7.111 43.8776 7.39153C44.1237 7.54333 44.3386 7.67549 44.5017 7.77068C44.5827 7.81798 44.6561 7.8593 44.7168 7.89018C44.747 7.90552 44.7791 7.92088 44.8102 7.93358C44.833 7.94288 44.8872 7.96457 44.9511 7.97183C45.1859 7.99847 45.398 7.91926 45.5648 7.8262C45.7334 7.73215 45.8923 7.60315 46.0322 7.47832C46.1706 7.35484 46.3143 7.21334 46.4334 7.10065C46.5607 6.98027 46.6658 6.887 46.7556 6.82521C46.8605 6.75293 47.1243 6.53346 47.4819 6.24307C47.8528 5.94185 48.3535 5.53987 48.9624 5.07513C49.934 4.33355 51.202 3.57909 52.4934 2.8036C53.4915 2.2043 54.5033 1.59172 55.3736 0.973724Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_8",
    type: 'bone',
    targetX: 93.51, 
    targetY: 332.68,
    pathData: "M50.6803 0.780212C52.7359 12.3311 64.2579 43.015 51.9203 51.4273C47.8029 54.2347 41.3585 59.3844 31.8582 59.3845C28.0614 59.3845 22.8104 58.0767 19.3245 60.1027C16.4588 61.7683 8.17229 66.3304 5.50997 62.2981C4.35608 60.5502 4.81348 58.081 4.83406 56.1138C4.8719 52.4911 2.30043 49.1126 0.630783 46.0572C7.00075 40.4663 13.3589 34.8472 20.309 29.9803C20.5988 29.7775 24.7619 27.7143 24.3898 26.6747C23.9667 25.4938 18.9958 25.566 18.1882 25.3063C22.7331 21.6543 27.639 18.2235 32.6625 15.2651C33.7099 14.6483 34.1686 14.3049 34.3368 14.1479C34.9897 13.5378 33.2356 12.9093 32.985 12.7671C35.689 9.95954 39.3828 7.94674 42.6367 5.86459C45.3179 4.14892 47.9113 2.33317 50.6803 0.780212Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_9",
    type: 'bone',
    targetX: 76.93, 
    targetY: 78.48,
    pathData: "M42.7891 0.510273C44.0968 0.452617 45.3393 0.647077 46.6338 0.832414C46.0023 20.7777 46.3644 43.1072 41.3093 62.4794C37.7774 76.014 35.9701 90.4308 34.6745 104.358C34.0153 111.445 32.512 118.369 31.7903 125.44C31.4582 128.694 31.0479 132.591 30.0487 138.293C27.2626 154.191 26.4556 170.29 23.8059 186.201C21.8571 197.903 21.4979 210.012 21.0166 221.841C20.4986 234.573 19.3385 247.357 17.0818 259.903C16.1181 265.26 15.4135 268.559 13.9049 270.844C13.5727 271.347 13.1873 272.05 12.7847 272.895C12.1293 271.829 11.0659 271.155 10.0539 270.564C9.17195 270.049 7.7136 269.457 7.22081 268.492C6.9922 268.043 6.86067 267.532 6.53828 267.137C6.01273 266.493 1.82949 267.176 0.602943 267.158C1.56896 262.103 2.05449 257 2.75717 251.899C6.5317 224.5 6.87778 196.864 11.16 169.524C11.3722 168.17 11.7378 166.851 11.9286 165.495C12.2462 163.24 12.5513 159.391 12.7329 156.094C13.7899 136.9 17.6852 117.935 19.9145 98.8615C20.5501 93.4231 21.2984 88.8567 21.8863 85.133C22.4761 81.3973 22.8994 78.536 22.8994 76.4708C22.8995 65.3852 26.8773 54.7717 27.7139 43.7761C28.2901 36.2022 30.3101 28.8092 31.3406 21.2788C32.2355 14.7391 32.3705 7.54815 34.2773 1.21008C37.043 0.642178 39.9788 0.634196 42.7891 0.510273Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_10",
    type: 'bone',
    targetX: 75.8, 
    targetY: 345.59,
    pathData: "M7.05716 0.579803C7.33893 0.928762 7.44916 1.4025 7.65106 1.79813C8.69249 3.83838 11.7292 4.16938 13.0789 6.00839C10.8882 6.85741 8.63441 7.61574 6.54931 8.70944C6.22923 8.63724 4.28872 8.63851 4.32484 8.14349C4.36862 7.55182 4.9834 7.07151 4.81136 6.43497C4.64784 5.95112 4.13662 5.92035 3.69748 6.01611C2.69185 6.23551 1.58391 7.06444 0.569473 6.77109C0.923617 4.73721 1.23235 2.71486 1.56532 0.874359C3.40133 0.889858 5.27067 1.1459 7.05716 0.579803Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_11",
    type: 'bone',
    targetX: 74.27, 
    targetY: 351.43,
    pathData: "M5.74886 0.829802C5.62618 1.28719 5.2944 1.68878 5.25866 2.17059C5.18446 3.17646 6.40407 3.32445 7.14075 3.40362C5.87706 4.15725 4.71448 5.04765 3.57404 5.97415C2.70891 6.67698 1.84531 7.51894 0.720367 7.76099C1.29923 5.81885 1.73743 3.72613 2.11484 1.63589C3.25659 2.12165 6.06991 -0.368723 5.74886 0.829802Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_12",
    type: 'bone',
    targetX: 70.02, 
    targetY: 351.66,
    pathData: "M19.5951 0.907166C18.7791 2.74918 17.9381 5.09973 17.375 7.46069C16.2631 7.75714 15.4197 9.0299 14.7085 9.82672C13.0348 11.702 8.65469 14.1158 9.92053 16.9708C9.0719 17.6529 8.54137 18.6318 7.88214 19.4792C6.74851 18.5638 5.90087 16.8365 4.3978 17.4467C3.23302 17.9196 2.11126 18.3664 0.854614 18.5157C2.40602 15.3601 3.76612 12.0837 4.85747 8.73932C6.27305 8.66497 7.39379 7.58484 8.43339 6.74026C11.8307 3.98029 15.5354 2.49213 19.5951 0.907166Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_13",
    type: 'bone',
    targetX: 77.62, 
    targetY: 359.15,
    pathData: "M9.39369 1.13388C8.65127 4.73704 8.96966 8.40838 9.34074 12.0422C6.89818 12.5755 4.48118 13.1999 2.04843 13.7514C1.53184 13.513 1.12098 13.0526 0.690735 12.6912C1.36084 11.8317 1.89766 10.7725 2.81775 10.1461C3.28569 9.83324 2.65138 9.01428 2.54562 8.74463C4.07988 6.76363 5.83031 4.9304 7.49762 3.06229C8.09285 2.39537 8.65492 1.65292 9.39369 1.13388Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "bone_14",
    type: 'bone',
    targetX: 67.18, 
    targetY: 368.75,
    pathData: "M7.53133 0.579895C8.56096 1.66917 9.80974 2.51083 10.9223 3.50784C13.2035 5.5521 17.198 3.17565 19.68 2.63776C20.2298 7.22041 22.7967 10.5659 24.9185 14.4845C26.9311 18.2017 29.4657 30.8467 23.2552 32.3884C16.5893 34.0425 5.748 30.7329 2.9103 23.7476C0.619504 18.1084 -0.344842 11.5269 1.38491 5.59589C1.7616 4.30437 2.28721 3.22166 2.98605 1.80667C4.01459 2.43082 6.56842 0.920708 7.53133 0.579895Z",
    color: "#ffcdd3",
    zIndex: 1
        },
        {
    name: "right_plate",
    type: 'plate',
    targetX: 106.38, 
    targetY: 258,
    pathData: "M41.0176 0C45.7114 8.96785e-05 49.5166 3.80519 49.5166 8.49902V120.501C49.5166 125.195 45.7114 129 41.0176 129C36.3237 129 32.5186 125.195 32.5186 120.501V93.3945H5.61426V93.3779L0 90.1367L5.61426 86.8945V86.874H32.5186V68.3945H5.61426V68.3779L0 65.1367L5.61426 61.8945V61.874H32.5186V44.3945H6.61426V44.3779L1 41.1367L6.61426 37.8945V37.874H32.5186V8.49902C32.5186 3.80514 36.3237 0 41.0176 0ZM41.0176 110.838C38.8957 110.838 37.1758 112.558 37.1758 114.68C37.1758 116.802 38.8957 118.521 41.0176 118.521C43.1394 118.521 44.8593 116.801 44.8594 114.68C44.8594 112.558 43.1394 110.838 41.0176 110.838ZM41.0176 86.3877C38.8957 86.3877 37.1758 88.1086 37.1758 90.2305C37.176 92.3522 38.8958 94.0723 41.0176 94.0723C43.1393 94.0722 44.8592 92.3522 44.8594 90.2305C44.8594 88.1086 43.1394 86.3878 41.0176 86.3877ZM41.0176 61.9385C38.8958 61.9385 37.176 63.6585 37.1758 65.7803C37.1758 67.9022 38.8957 69.623 41.0176 69.623C43.1394 69.623 44.8594 67.9021 44.8594 65.7803C44.8592 63.6586 43.1393 61.9386 41.0176 61.9385ZM41.0176 37.4893C38.8957 37.4893 37.1759 39.2092 37.1758 41.3311C37.1758 43.453 38.8957 45.1729 41.0176 45.1729C43.1394 45.1728 44.8594 43.4529 44.8594 41.3311C44.8593 39.2093 43.1394 37.4893 41.0176 37.4893ZM41.0176 13.04C38.8957 13.04 37.1758 14.7599 37.1758 16.8818C37.1758 19.0037 38.8957 20.7236 41.0176 20.7236C43.1394 20.7235 44.8593 19.0037 44.8594 16.8818C44.8594 14.76 43.1394 13.0401 41.0176 13.04Z",
    color: "#cfd8dc",
    zIndex: 2
        },
        {
    name: "left_plate",
    type: 'plate',
    targetX: 65, 
    targetY: 335,
    pathData: "M5 0C7.76142 0 10 2.23858 10 5V12.3076H18.3701V12.3291L22.3105 14.6055L18.3701 16.8809V16.8838H18.3652L18.3516 16.8916V16.8838H10V28.3076H18.3701V28.3291L22.3105 30.6055L18.3701 32.8809V32.8838H18.3652L18.3516 32.8916V32.8838H10V40C10 42.7614 7.76142 45 5 45C2.23858 45 2.01337e-08 42.7614 0 40V5C0 2.23858 2.23858 0 5 0ZM5 28C3.34315 28 2 29.3431 2 31C2 32.6569 3.34315 34 5 34C6.65685 34 8 32.6569 8 31C8 29.3431 6.65685 28 5 28ZM5 12C3.34315 12 2 13.3431 2 15C2 16.6569 3.34315 18 5 18C6.65685 18 8 16.6569 8 15C8 13.3431 6.65685 12 5 12Z",
    color: "#cfd8dc",
    zIndex: 2
        }
    ];

    let pieces = [];
    let isDragging = false;
    let selectedPiece = null;
    let dragOffset = {x: 0, y: 0};
    let isCompleted = false;

    // --- ヘルパー関数 ---
    function buildPath(c, pathData) {
        c.beginPath();
        if (pathData.length < 2) return;
        c.moveTo(pathData[0], pathData[1]);
        for(let i=2; i<pathData.length; i+=2) {
            c.lineTo(pathData[i], pathData[i+1]);
        }
        c.closePath();
    }

    function drawCircle(c, x, y, r) {
        c.moveTo(x + r, y);
        c.arc(x, y, r, 0, Math.PI * 2);
    }

    // --- 初期化 ---
    function init() {
        // 修正点: まずピースを生成する
        pieces = piecesDef.map((def, index) => {
            // 初期位置をランダムに
            let startX, startY;
            if (index % 2 === 0) {
                startX = 50 + Math.random() * 50;
            } else {
                startX = baseWidth - 100 + Math.random() * 50;
            }
            startY = 50 + Math.random() * (baseHeight - 100);

            return {
                ...def,
                x: startX,
                y: startY,
                isLocked: false,
                id: index
            };
        });

        // その後にリサイズ（描画）を行う
        window.addEventListener('resize', resize);
        resize();
        
        statusDiv.textContent = "バラバラの骨をドラッグして整復してください";
    }

    function resize() {
        const winW = window.innerWidth * 0.95;
        const winH = window.innerHeight * 0.8;
        scale = Math.min(winW / baseWidth, winH / baseHeight);
        
        // ★追加: デバイスの画素密度（DPR）を取得（iPhoneなら2や3になります）
        const dpr = window.devicePixelRatio || 1;

        // ★変更: 内部の解像度をDPR倍にして高精細にする
        canvas.width = baseWidth * scale * dpr;
        canvas.height = baseHeight * scale * dpr;

        // ★追加: でも、画面上の見た目のサイズは大きくならないようにCSSで押さえる
        canvas.style.width = `${baseWidth * scale}px`;
        canvas.style.height = `${baseHeight * scale}px`;
        
        // ★変更: 描画の基準もDPR倍に拡大する
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(scale * dpr, scale * dpr);
        
        draw();
    }

    // --- 描画ロジック ---
// --- 描画ロジック ---
    function drawPiecePath(c, p) {
        // SVGデータ(pathData)がある場合（新しい骨やプレート）
        if (p.pathData) {
            if (!p.cachedPath) {
                p.cachedPath = new Path2D(p.pathData);
            }
            // SVGデータがある場合は Path2Dオブジェクトを返すだけにする
            return p.cachedPath; 
        } 
    }

/* drawPiecePath から返ってきたデータを使って、実際に色を塗る処理に変更 */
    function draw() {
        if (!pieces || pieces.length === 0) return;

        ctx.clearRect(0, 0, baseWidth, baseHeight);

        // ★追加: 骨がすべて完了しているかチェック
        const allBonesLocked = pieces
            .filter(p => p.type === 'bone')
            .every(p => p.isLocked);

        // 1. ガイドライン（点線）
        ctx.save();
        ctx.setLineDash([4, 4]);
        pieces.forEach(p => {
            // ★追加: プレートは、骨が終わるまで表示しない
            if (p.type === 'plate' && !allBonesLocked) return;

            if (!p.isLocked) {
                ctx.save();
                ctx.translate(p.targetX, p.targetY);
                
                const path2d = drawPiecePath(ctx, p);
                
                ctx.strokeStyle = "#bdbdbd";
                ctx.lineWidth = 1;
                
                if (path2d) {
                    ctx.stroke(path2d);
                } else {
                    ctx.stroke();
                }
                ctx.restore();
            }
        });
        ctx.restore();

        // 2. ピース描画（実体）
        const sortedPieces = [...pieces].sort((a, b) => {
            if (a.isLocked !== b.isLocked) return a.isLocked ? -1 : 1;
            return a.zIndex - b.zIndex;
        });
        
        if (selectedPiece) {
            const idx = sortedPieces.indexOf(selectedPiece);
            if (idx > -1) {
                sortedPieces.splice(idx, 1);
                sortedPieces.push(selectedPiece);
            }
        }

        sortedPieces.forEach(p => {
            // ★追加: プレートは、骨が終わるまで表示しない
            if (p.type === 'plate' && !allBonesLocked) return;

            ctx.save();
            ctx.translate(p.x, p.y);

            if (p === selectedPiece && !p.isLocked) {
                ctx.shadowColor = "rgba(0,0,0,0.3)";
                ctx.shadowBlur = 10;
                ctx.shadowOffsetY = 5;
            }

            const path2d = drawPiecePath(ctx, p);

            if (p.type === 'plate') {
                ctx.fillStyle = p.isLocked ? "#b0bec5" : p.color;
                ctx.strokeStyle = p.strokeColor || "#78909c";
                ctx.lineWidth = 1;

                if (path2d) {
                    ctx.fill(path2d, "evenodd");
                    ctx.stroke(path2d);
                } else {
                    ctx.fill("evenodd");
                    ctx.stroke();
                }
            } else {
                ctx.fillStyle = p.isLocked ? "#ffe0b2" : p.color;
                ctx.strokeStyle = "#5d4037";
                ctx.lineWidth = 1;

                if (path2d) {
                    ctx.fill(path2d);
                    ctx.stroke(path2d);
                } else {
                    ctx.fill();
                    ctx.stroke();
                }
            }
            ctx.restore();
        });

        updateProgress();
    }

function updateProgress() {
        if (!pieces || pieces.length === 0) return;

        const bones = pieces.filter(p => p.type === 'bone');
        const plates = pieces.filter(p => p.type === 'plate');

        const lockedBonesCount = bones.filter(p => p.isLocked).length;
        const lockedPlatesCount = plates.filter(p => p.isLocked).length;

        const totalBones = bones.length;
        const totalPlates = plates.length;
        const totalPieces = totalBones + totalPlates;
        const totalLocked = lockedBonesCount + lockedPlatesCount;

        let ratio = totalLocked / totalPieces;
        
        // ★リセット: 通常時は元の位置に戻す
        statusDiv.style.position = "absolute";
        statusDiv.style.bottom = "calc(30px + env(safe-area-inset-bottom))";
        statusDiv.style.top = "auto";
        statusDiv.style.left = "0";
        statusDiv.style.transform = "none";
        statusDiv.style.width = "100%";
        statusDiv.style.backgroundColor = "transparent";
        statusDiv.style.padding = "0";
        statusDiv.style.borderRadius = "0";
        statusDiv.style.boxShadow = "none";
        statusDiv.style.fontSize = "1rem";

        if (lockedBonesCount < totalBones) {
            statusDiv.textContent = `小さな骨片も忘れずに！ (${lockedBonesCount}/${totalBones})`;
        } else if (lockedPlatesCount < totalPlates) {
            statusDiv.textContent = `仕上げにプレートで固定しましょう (${lockedPlatesCount}/${totalPlates})`;
        } else if (!isCompleted) {
            // --- ▼ 成功時の演出（中央表示に変更） ▼ ---
            isCompleted = true;
            
            statusDiv.textContent = "完成！おめでとう！";
            
            // ★CSSを動的に変更して中央に配置
            statusDiv.style.bottom = "auto";
            statusDiv.style.top = "50%";
            statusDiv.style.left = "50%";
            statusDiv.style.transform = "translate(-50%, -50%) scale(1.5)"; // 中央配置 + 拡大
            statusDiv.style.width = "80%"; // 幅を制限
            statusDiv.style.backgroundColor = "rgba(255, 255, 255, 0.9)"; // 背景を白く
            statusDiv.style.padding = "20px";
            statusDiv.style.borderRadius = "15px";
            statusDiv.style.boxShadow = "0 10px 10px rgba(0,0,0,0.2)";
            statusDiv.style.zIndex = "100"; // 最前面へ
            statusDiv.style.transition = "all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; // ボヨヨンというアニメーション

            // スマホの振動
            if(navigator.vibrate) navigator.vibrate([100,50,100,50,200]);

            // 紙吹雪発射
            const duration = 1500;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.8 },
                    colors: ['#F06292', '#BA68C8', '#4FC3F7', '#FF8A65']
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.8 },
                    colors: ['#F06292', '#BA68C8', '#4FC3F7', '#FF8A65']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }
    }
    // --- 入力イベント ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;

        // ★修正: 「実際のキャンバス幅(400)」と「画面上の表示幅(rect.width)」の比率を使う
        // これにより、DPRに関係なく、常に正しいゲーム内座標(0〜400)が取得できます
        return {
            x: (cx - rect.left) * (baseWidth / rect.width),
            y: (cy - rect.top) * (baseHeight / rect.height)
        };
    }

/* マウスが骨の上に乗ったかどうかの判定ロジックを、高画質＆SVG対応版に変更 */
    function isInside(pos, p) {
        ctx.save();
        
        // ★ここが修正ポイント！
        // 当たり判定の時だけは、高画質化や画面拡大の設定（scale/dpr）を
        // 一旦リセットして、「純粋な400x600の座標系」として計算させます。
        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        
        // ピースの位置へ移動
        ctx.translate(p.x, p.y);
        
        const path2d = drawPiecePath(ctx, p);
        let hit = false;

        if (path2d) {
            // 1. 形の内側かどうかを判定
            hit = ctx.isPointInPath(path2d, pos.x, pos.y);
            
            // 2. もし内側でなければ、線の太さを太くして判定
            if (!hit) {
                ctx.lineWidth = 20; 
                hit = ctx.isPointInStroke(path2d, pos.x, pos.y);
            }
        } else {
            // 従来方式
            hit = ctx.isPointInPath(pos.x, pos.y);
            
            if (!hit) {
                 const dist = Math.sqrt(pos.x*pos.x + pos.y*pos.y);
                 if (dist < 30) hit = true;
            }
        }
        
        ctx.restore(); // リセットした設定を元に戻す（描画用に戻す）
        return hit;
    }

    function handleStart(e) {
        if (isCompleted) return;
        if (e.touches && e.touches.length > 1) return;
        e.preventDefault();
        const pos = getPos(e);

        // ★追加: 骨がすべて完了しているかチェック
        const allBonesLocked = pieces
            .filter(p => p.type === 'bone')
            .every(p => p.isLocked);

        // タッチ候補の選定
        const candidates = pieces.filter(p => {
            // 既にロックされているものは除外
            if (p.isLocked) return false;
            // ★追加: 骨が終わっていない場合、プレートは触れないように除外
            if (p.type === 'plate' && !allBonesLocked) return false;
            
            return true;
        });

        for (let i = candidates.length - 1; i >= 0; i--) {
            if (isInside(pos, candidates[i])) {
                selectedPiece = candidates[i];
                isDragging = true;
                dragOffset.x = pos.x - candidates[i].x;
                dragOffset.y = pos.y - candidates[i].y;
                draw();
                return;
            }
        }
    }

    function handleMove(e) {
// ★追加: 指が2本以上ある場合はブラウザのズーム動作を優先させるため、処理を中断
        if (e.touches && e.touches.length > 1) return;

        if (!isDragging || !selectedPiece) return;
        e.preventDefault(); // ←1本指のときだけ、画面スクロールを止める
        const pos = getPos(e);
        selectedPiece.x = pos.x - dragOffset.x;
        selectedPiece.y = pos.y - dragOffset.y;
        draw();
    }

    function handleEnd(e) {
        if (!isDragging || !selectedPiece) return;
        e.preventDefault();

        const dx = selectedPiece.x - selectedPiece.targetX;
        const dy = selectedPiece.y - selectedPiece.targetY;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < snapDistance) {
            const allBonesDone = pieces.filter(p => p.type === 'bone').every(p => p.isLocked);
            
            if (selectedPiece.type === 'plate' && !allBonesDone) {
                statusDiv.textContent = "先に骨をすべてくっつけてください！";
                if(navigator.vibrate) navigator.vibrate(100);
            } else {
                selectedPiece.x = selectedPiece.targetX;
                selectedPiece.y = selectedPiece.targetY;
                selectedPiece.isLocked = true;
                statusDiv.textContent = "カチッ！";
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }

        isDragging = false;
        selectedPiece = null;
        draw();
    }

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    canvas.addEventListener('touchmove', handleMove, {passive: false});
    canvas.addEventListener('touchend', handleEnd);

    // 実行開始
    init();
